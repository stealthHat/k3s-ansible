---
- name: Disable swap on Raspbian
  apt:
    name: dphys-swapfile
    state: absent
    purge: yes

- name: Set timezone to America/Sao_Paulo
  timezone:
    name: America/Sao_Paulo

- name: Ensure GB-UTF8 locale exists
  locale_gen:
    name: en_GB.UTF-8
    state: present

- name: Update and Upgrade system
  apt:
    autoremove: yes
    update_cache: yes
    upgrade: dist

- name: Disable HDMI
  lineinfile:
    dest: /etc/rc.local
    regexp: "^/usr/bin/tvservice"
    line: "/usr/bin/tvservice -o"
    insertbefore: "^exit"
    state: present

- name: Enable container features
  replace:
    path: /boot/cmdline.txt
    regexp: '^([\w](?!.*\b{{ item }}\b).*)$'
    replace: '\1 {{ item }}'
  with_items:
  - "cgroup_enable=cpuset"
  - "cgroup_memory=1"
  - "cgroup_enable=memory"

- name: Flush iptables before changing to iptables-legacy
  iptables:
    flush: true
  changed_when: false   

- name: Changing to iptables-legacy
  alternatives:
    path: /usr/sbin/iptables-legacy
    name: iptables
  register: ip4_legacy

- name: Changing to ip6tables-legacy
  alternatives:
    path: /usr/sbin/ip6tables-legacy
    name: ip6tables
  register: ip6_legacy

- name: Update the mirrolist
  copy:
    src:  ../files/sources.list
    dest: /etc/apt/sources.list

- name: Copy Alias to Host
  copy:
    src:  ../files/.zshalias
    dest: /home/pi/.zshalias

- name: Source de Alias
  shell: echo source /home/pi/.zshalias >> /home/pi/.profile

- name: Restart to finalize the changes
  reboot:
    reboot_timeout: 60
    post_reboot_delay: 15
