---
- name: Update the mirrolist
  copy:
    src:  ../files/sources.list
    dest: /etc/apt/sources.list

- name: Set timezone to America/Sao_Paulo
  timezone:
    name: America/Sao_Paulo

- name: Ensure GB-UTF8 locale exists
  locale_gen:
    name: en_GB.UTF-8
    state: present

- name: Disable swap on Raspbian
  apt:
    name: dphys-swapfile
    state: absent
    purge: yes

- name: Disable HDMI
  lineinfile:
    dest: /etc/rc.local
    regexp: "^/usr/bin/tvservice"
    line: "/usr/bin/tvservice -o"
    insertbefore: "^exit"
    state: present
    
- name: Update and Upgrade system
  apt:
    autoremove: yes
    update_cache: yes
    upgrade: dist
  notify: reboot

- name: Activating cgroup support
  lineinfile:
    path: /boot/cmdline.txt
    regexp: '^((?!.*\bcgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory\b).*)$'
    line: '\1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory'
    backrefs: true
  notify: reboot

- name: Restart to finalize the changes
  reboot:
    reboot_timeout: 60
    post_reboot_delay: 15

- name: Flush iptables before changing to iptables-legacy
  iptables:
    flush: true
  changed_when: false   

- name: Changing to iptables-legacy
  alternatives:
    path: /usr/sbin/iptables-legacy
    name: iptables
  register: ip4_legacy

- name: Changing to ip6tables-legacy
  alternatives:
    path: /usr/sbin/ip6tables-legacy
    name: ip6tables
  register: ip6_legacy

- name: Enable IPv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    state: present
    reload: yes

- name: Enable IPv6 forwarding
  sysctl:
    name: net.ipv6.conf.all.forwarding
    value: "1"
    state: present
    reload: yes

- name: Copy Alias to Host
  copy:
    src:  ../files/.zshalias
    dest: /home/pi/.zshalias

- name: Source de Alias
  shell: echo source /home/pi/.zshalias >> /home/pi/.profile

- name: Restart to finalize the changes
  reboot:
    reboot_timeout: 60
    post_reboot_delay: 15
